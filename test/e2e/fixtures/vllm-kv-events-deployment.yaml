apiVersion: apps/v1
kind: Deployment
metadata:
  name: vllm-kv-events-test
  labels:
    model.aibrix.ai/name: test-model
    model.aibrix.ai/port: "8000"
    model.aibrix.ai/kv-events-enabled: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      model.aibrix.ai/name: test-model
  template:
    metadata:
      labels:
        model.aibrix.ai/name: test-model
        model.aibrix.ai/kv-events-enabled: "true"
    spec:
      containers:
      - name: vllm-mock
        image: aibrix/vllm-mock:nightly
        command:
        - python3
        - -m
        - vllm.entrypoints.openai.api_server
        - --host
        - "0.0.0.0"
        - --port
        - "8000"
        - --model
        - meta-llama/Llama-2-7b-hf
        - --served-model-name
        - test-model
        - --enable-kv-cache-events
        - --kv-events-publisher
        - zmq
        - --kv-events-endpoint
        - "tcp://*:5557"
        - --kv-events-replay-endpoint
        - "tcp://*:5558"
        - --kv-events-buffer-steps
        - "10000"
        ports:
        - containerPort: 8000
          name: api
          protocol: TCP
        - containerPort: 5557
          name: kv-events
          protocol: TCP
        - containerPort: 5558
          name: kv-replay
          protocol: TCP
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: "1"
            memory: 1Gi
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          periodSeconds: 5
          timeoutSeconds: 1
---
apiVersion: v1
kind: Service
metadata:
  name: vllm-kv-events-test
  labels:
    model.aibrix.ai/name: test-model
spec:
  ports:
  - name: serve
    port: 8000
    protocol: TCP
    targetPort: 8000
  - name: kv-events
    port: 5557
    protocol: TCP
    targetPort: 5557
  - name: kv-replay
    port: 5558
    protocol: TCP
    targetPort: 5558
  selector:
    model.aibrix.ai/name: test-model
  type: ClusterIP